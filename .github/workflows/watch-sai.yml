name: Watch SAI Version Updates

on:
  schedule:
    - cron: "0 1 * * *"   # 每天北京时间上午 9 点检查一次
  workflow_dispatch:

jobs:
  check-sai:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream
        run: |
          git remote add upstream https://github.com/sonic-net/sonic-buildimage.git
          git fetch upstream

      - name: Compare sai.mk
        id: diffcheck
        run: |
          FILE="platform/broadcom/sai.mk"

          git fetch upstream master
          git fetch origin master

          git diff upstream/master:$FILE origin/master:$FILE > sai.diff || true

          if [ -s sai.diff ]; then
              echo "changed=true" >> $GITHUB_OUTPUT
          else
              echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue when changed
        if: steps.diffcheck.outputs.changed == 'true'
        id: issue
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "SAI Version Updated in Upstream"
          content-filepath: sai.diff
          labels: sai,monitoring

      - name: Send Email Notification
        if: steps.diffcheck.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const email = "zhijun@micasnetworks.com";
            const issueUrl = core.getInput('issue-url') || '${{ steps.issue.outputs.issue-url }}';
            const diff = require('fs').readFileSync('sai.diff', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.issue.outputs.issue-number }},
              body: `Notification email sent to ${email}.`
            });

            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: "email_notification",
              client_payload: {
                to: email,
                subject: "SAI Version Updated",
                body: `Upstream updated platform/broadcom/sai.mk\n\nIssue: ${issueUrl}\n\nDiff:\n${diff}`
              }
            });
